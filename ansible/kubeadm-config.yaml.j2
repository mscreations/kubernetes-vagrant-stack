{% if mode=="init" %}
apiVersion: kubeadm.k8s.io/v1beta4
kind: InitConfiguration

bootstrapTokens:
  - token: "{{ token }}"
    ttl: "24h"

certificateKey: "{{ certificate_key }}"

localAPIEndpoint:
  advertiseAddress: "{{ ansible_default_ipv4.address }}"
  bindPort: 6443

{% else %}
apiVersion: kubeadm.k8s.io/v1beta4
kind: JoinConfiguration
discovery:
  bootstrapToken:
    token: "{{ token }}"
    unsafeSkipCAVerification: true

controlPlane:
  certificateKey: "{{ certificate_key }}"
  localAPIEndpoint:
    advertiseAddress: "{{ ansible_default_ipv4.address }}"
    bindPort: 6443

{% endif %}
---
# kubeadm ClusterConfiguration
apiVersion: kubeadm.k8s.io/v1beta4
kind: ClusterConfiguration

kubernetesVersion: "{{ k8s_version }}"

{% if setup_lb %}
controlPlaneEndpoint: "{{ network_prefix }}.200:443"
{% endif %}

networking:
  podSubnet: "10.244.0.0/16"
  serviceSubnet: "10.96.0.0/12"

apiServer:
  extraArgs:
    profiling: "false"
    encryption-provider-config: /etc/kubernetes/encryption-config.yaml
  extraVolumes:
    - name: encryption-config
      hostPath:
        path: /etc/kubernetes/encryption-config.yaml
        type: File
  extraVolumeMounts:
    - name: encryption-config
      mountPath: /etc/kubernetes/encryption-config.yaml
      readOnly: true

controllerManager:
  extraArgs:
    bind-address: "0.0.0.0"
    secure-port: "10257"

scheduler:
  extraArgs:
    bind-address: "0.0.0.0"
    secure-port: "10259"

etcd:
  local:
    extraArgs:
      listen-metrics-urls: "https://{{ ansible_default_ipv4.address }}:2381"
      cert-file: "/etc/kubernetes/pki/etcd/server.crt"
      key-file: "/etc/kubernetes/pki/etcd/server.key"
      trusted-ca-file: "/etc/kubernetes/pki/etcd/ca.crt"
