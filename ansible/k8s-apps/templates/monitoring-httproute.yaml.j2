---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: prometheus-httproute
  namespace: kube-prometheus-stack
  labels:
    gateway: traefik
spec:
  parentRefs:
  - name: traefik-gateway
    sectionName: websecure
    namespace: traefik
  hostnames:
  - "metrics.{{ lookup('env', 'TRAEFIK_DOMAIN') }}"
  rules:
  - backendRefs:
    - name: kube-prometheus-stack-grafana
      port: 80
      kind: Service
      namespace: kube-prometheus-stack
    matches:
    - path:
        type: PathPrefix
        value: /grafana
    filters:
      - type: ExtensionRef
        extensionRef:
          group: traefik.io
          kind: Middleware
          name: cloudflare-middleware
  - backendRefs:
    - name: prometheus-operated
      port: 9090
      kind: Service
      namespace: kube-prometheus-stack
    matches:
    - path:
        type: PathPrefix
        value: /prometheus
    filters:
      - type: ExtensionRef
        extensionRef:
          group: traefik.io
          kind: Middleware
          name: cloudflare-middleware
      - type: URLRewrite
        urlRewrite:
          path:
            type: ReplacePrefixMatch
            replacePrefixMatch: /
  - matches:
    - path:
        type: PathPrefix
        value: /
    filters:
      - type: ExtensionRef
        extensionRef:
          group: traefik.io
          kind: Middleware
          name: cloudflare-middleware
      - type: RequestRedirect
        requestRedirect:
          path:
            type: ReplaceFullPath
            replaceFullPath: /grafana
          statusCode: 302