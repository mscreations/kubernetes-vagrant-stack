---
- name: Stage 2 Worker Playbook
  hosts: workers
  become: yes

  tasks:
    - name: Set network_prefix from node's IP address
      ansible.builtin.set_fact:
        network_prefix: "{{ ansible_default_ipv4.address.split('.')[:3] | join('.') }}"

    - name: Check if the node is already part of a Kubernetes cluster
      ansible.builtin.stat:
        path: /etc/kubernetes/kubelet.conf
      register: kubelet_conf

    - name: Join the worker node to the Kubernetes cluster
      ansible.builtin.shell: |
        kubeadm join k8s-api.{{ ansible_facts.domain }}:443 \
          --token {{ lookup('env', 'K8S_TOKEN') }} \
          --discovery-token-unsafe-skip-ca-verification
      register: join_cluster
      when: not kubelet_conf.stat.exists
